# middleware injection works

    Code
      injection(dummy_engine)
    Output
      [1] "<script>\n    (function() {\n        if (!document.getElementById('hotwater-reloader')) {\n            document.currentScript.id = \"hotwater-reloader\"\n            document.body.appendChild(document.currentScript)\n            let ws = new WebSocket('1234', ['pub.sp.nanomsg.org']);\n            ws.binaryType = \"arraybuffer\";\n\n            function extractPayload(text) {\n                const m = text.match(/HW::[A-Za-z0-9_:-]+/);\n                return m ? m[0] : \"\";\n            }\n\n            function stripTrailingNulls(u8) {\n                let end = u8.length;\n                while (end > 0 && u8[end - 1] === 0) end--;\n                return u8.subarray(0, end);\n            }\n\n            function newlink(url) {\n                const u = new URL(url, window.location.href);\n                u.searchParams.set('__hotwater', Date.now());\n                return u.toString();\n            }\n\n            function reloadCSS() {\n                document.querySelectorAll('link[rel=\"stylesheet\"]').forEach((link) => {\n                    const href = link.getAttribute('href');\n                    if (!href) return;\n                    const next = link.cloneNode(true);\n                    next.href = newlink(href);\n                    next.addEventListener('load', () => link.remove(), { once: true });\n                    link.parentNode.insertBefore(next, link.nextSibling);\n                });\n            }\n\n            function reloadImages() {\n                document.querySelectorAll('img').forEach((img) => {\n                    const src = img.getAttribute('src');\n                    if (!src) return;\n                    img.src = newlink(src);\n                });\n            }\n\n\n\n            ws.onmessage = (ev) => {\n                try {\n                    const u8 = stripTrailingNulls(new Uint8Array(ev.data));\n                    const text = new TextDecoder(\"utf-8\").decode(u8);\n                    const msg = JSON.parse(text);\n                    switch (msg.type) {\n                        case \"HW::resource\": {\n                            const targets = msg.targets.map((v) => {\n                                return v.split('.').pop();\n                            });\n                            const unique_targets = [...new Set(targets)];\n\n                            if (unique_targets.includes(\"css\")) {\n                                reloadCSS();\n                            }\n\n                            if (unique_targets.length > 1 || !unique_targets.includes(\"css\")) {\n                                reloadImages();\n                            }\n\n                            break;\n                        }\n                        case \"HW::page\": {\n                            window.location.reload();\n                            break;\n                        }\n                        default: new Error(`Unkown payload ${msg.type}`)\n                    }\n                } catch (error) {\n                    console.log(error);\n                }\n            };\n        } else {\n            let checker = document.currentScript;\n            checker.parentNode.removeChild(checker);\n        }\n    })();\n</script>"

