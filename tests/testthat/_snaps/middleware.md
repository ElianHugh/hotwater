# middleware injection works

    Code
      injection(dummy_engine)
    Output
      [1] "<script>\n    (function() {\n        if (!document.getElementById('hotwater-reloader')) {\n            document.currentScript.id = \"hotwater-reloader\"\n            document.body.appendChild(document.currentScript)\n            let ws = new WebSocket('1234', ['pub.sp.nanomsg.org']);\n            ws.binaryType = \"arraybuffer\";\n\n            function extractPayload(text) {\n                const m = text.match(/HW::[A-Za-z0-9_:-]+/);\n                return m ? m[0] : \"\";\n            }\n\n            function newlink(url) {\n                const u = new URL(url, window.location.href);\n                u.searchParams.set('__hotwater', Date.now());\n                return u.toString();\n            }\n\n            function reloadCSS() {\n                document.querySelectorAll('link[rel=\"stylesheet\"]').forEach((link) => {\n                    const href = link.getAttribute('href');\n                    if (!href) return;\n                    const next = link.cloneNode(true);\n                    next.href = newlink(href);\n                    next.addEventListener('load', () => link.remove(), { once: true });\n                    link.parentNode.insertBefore(next, link.nextSibling);\n                });\n            }\n\n            function reloadImages() {\n                document.querySelectorAll('img').forEach((img) => {\n                    const src = img.getAttribute('src');\n                    if (!src) return;\n                    img.src = newlink(src);\n                });\n            }\n\n            ws.onmessage = (ev) => {\n                const decoded = new TextDecoder().decode(new Uint8Array(ev.data));\n                const payload = extractPayload(decoded);\n                switch(payload) {\n                    case \"HW::resource\": {\n                        console.log(\"hotwater: hot swapping resouces\");\n                        reloadCSS();\n                        reloadImages();\n                        break;\n                    }\n                    case \"HW::start\": {\n                         window.location.reload();\n                         break;\n                    }\n                    default: new Error(`Unkown payload ${payload}`)\n                }\n            };\n        } else {\n            let checker = document.currentScript;\n            checker.parentNode.removeChild(checker);\n        }\n    })();\n</script>"

