# middleware injection works

    Code
      injection(dummy_engine)
    Output
      [1] "(function() {\n    if (document.getElementById('hotwater-reloader')) {\n        let checker = document.currentScript;\n        checker.parentNode.removeChild(checker);\n        return;\n    }\n\n    document.currentScript.id = \"hotwater-reloader\"\n    document.head.appendChild(document.currentScript)\n\n    if (window.__hotwater_reloader_started) return;\n    window.__hotwater_reloader_started = true;\n\n    function stripTrailingNulls(u8) {\n        let end = u8.length;\n        while (end > 0 && u8[end - 1] === 0) end--;\n        return u8.subarray(0, end);\n    }\n\n    function newlink(url) {\n        const u = new URL(url, window.location.href);\n        u.searchParams.set('__hotwater', Date.now());\n        return u.toString();\n    }\n\n    function reloadCSS(targets) {\n        document.querySelectorAll('link[rel=\"stylesheet\"]').forEach((link) => {\n            const href = link.getAttribute('href');\n            if (!href) return;\n\n            if (!targets.includes(basename(href))) return;\n\n            const next = link.cloneNode(true);\n            next.href = newlink(href);\n            next.addEventListener('load', () => link.remove(), { once: true });\n\n            next.addEventListener('error', () => {\n                next.remove();\n                console.warn(\"hotwater: CSS swap failed (missing file?):\", href);\n            }, { once: true });\n\n            link.parentNode.insertBefore(next, link.nextSibling);\n        });\n    }\n\n    function reloadImages(targets) {\n        const rewriteSrcset = (srcset, targets) => {\n            return srcset\n                .split(',')\n                .map(e => {\n                    const parts = e.trim().split(/\\s+/);\n                    const url = parts[0];\n                    const desc = parts.slice(1).join(' ');\n\n                    if (targets.includes(basename(url))) {\n                        const next = newlink(url);\n                        return desc ? `${next} ${desc}` : next;\n                    }\n                    return e.trim();\n                })\n                .join(', ')\n        };\n\n\n        document.querySelectorAll('img').forEach((img) => {\n            const src = img.getAttribute('src');\n            const srcset = img.getAttribute('srcset');\n\n            if (srcset) {\n                img.setAttribute('srcset', rewriteSrcset(srcset, targets));\n                return;\n            }\n\n            if (!src) return;\n            if (!targets.includes(basename(src))) return;\n            if (/^(data:|blob:)/i.test(src)) return;\n\n            img.src = newlink(src);\n        });\n\n        document.querySelectorAll('picture source[srcset]').forEach(el => {\n            const srcset = el.getAttribute('srcset');\n            if (!srcset) return;\n            el.setAttribute('srcset', rewriteSrcset(srcset, targets));\n        });\n    }\n\n    function basename(path) {\n        try {\n            return new URL(path, window.location.href).pathname.split(\"/\").pop();\n        } catch {\n            return String(path).split(/[?#]/)[0].replace(/\\\\/g, \"/\").split(\"/\").pop();\n        }\n    }\n\n\n    let ws = null;\n    let everConnected = false;\n\n\n    function startSocket() {\n        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {\n            return;\n        }\n\n        ws = new WebSocket('1234', ['pub.sp.nanomsg.org']);\n        ws.binaryType = \"arraybuffer\";\n\n        ws.onopen = () => {\n            if (everConnected) {\n                window.location.reload();\n            }\n            everConnected = true;\n        };\n\n        ws.onmessage = async (ev) => {\n            try {\n                let data = ev.data;\n                if (data instanceof Blob) data = await data.arrayBuffer();\n\n                const u8 = stripTrailingNulls(new Uint8Array(data));\n                const text = new TextDecoder(\"utf-8\").decode(u8);\n                const msg = JSON.parse(text);\n\n                switch (msg.type) {\n                    case \"HW::resource\": {\n\n                        const targets = msg.targets.map((v) => {\n                            return basename(v);\n                        });\n                        const exts = targets.map((v) => {\n                            return v.split('.').pop();\n                        });\n\n                        const unique_exts = [...new Set(exts)];\n\n                        if (unique_exts.includes(\"css\")) {\n                            const css_targets = targets.filter((v) => {\n                                return v.includes(\".css\");\n                            });\n                            reloadCSS(css_targets);\n                        }\n\n                        if (!unique_exts.every(ext => ext === \"css\")) {\n                            const asset_targets = targets.filter((v) => {\n                                return !v.includes(\".css\");\n                            });\n                            reloadImages(asset_targets);\n                        }\n\n                        break;\n                    }\n                    case \"HW::page\": {\n                        window.location.reload();\n                        break;\n                    }\n                    case \"HW::error\": {\n                        console.warn(`hotwater: ${msg.error}`);\n                        break;\n                    }\n                    default: throw new Error(`Unknown payload ${msg.type}`)\n                }\n            } catch (error) {\n                console.log(error);\n            }\n        };\n\n        ws.onclose = (ev) => {\n            ws = null;\n            setTimeout(startSocket, 5000);\n        }\n\n        ws.onerror = () => {\n            console.warn(\"hotwater: error\");\n        }\n    }\n\n\n    startSocket();\n})();"

