# middleware injection works

    Code
      injection(dummy_engine)
    Output
      [1] "<script>\n    (function() {\n        if (document.getElementById('hotwater-reloader')) {\n            let checker = document.currentScript;\n            checker.parentNode.removeChild(checker);\n            return;\n        }\n\n        document.currentScript.id = \"hotwater-reloader\"\n        document.body.appendChild(document.currentScript)\n\n        function stripTrailingNulls(u8) {\n            let end = u8.length;\n            while (end > 0 && u8[end - 1] === 0) end--;\n            return u8.subarray(0, end);\n        }\n\n        function newlink(url) {\n            const u = new URL(url, window.location.href);\n            u.searchParams.set('__hotwater', Date.now());\n            return u.toString();\n        }\n\n        function reloadCSS() {\n            document.querySelectorAll('link[rel=\"stylesheet\"]').forEach((link) => {\n                const href = link.getAttribute('href');\n                if (!href) return;\n                const next = link.cloneNode(true);\n                next.href = newlink(href);\n                next.addEventListener('load', () => link.remove(), { once: true });\n                link.parentNode.insertBefore(next, link.nextSibling);\n            });\n        }\n\n        function reloadImages() {\n            document.querySelectorAll('img').forEach((img) => {\n                const src = img.getAttribute('src');\n                if (!src) return;\n                if (/^(data:|blob:)/i.test(src)) return;\n                img.src = newlink(src);\n            });\n        }\n\n        function basename(path) {\n            try {\n                return new URL(path, window.location.href).pathname.split(\"/\").pop();\n            } catch {\n                return String(path).split(/[?#]/)[0].replace(/\\\\/g, \"/\").split(\"/\").pop();\n            }\n        }\n\n        let ws = new WebSocket('1234', ['pub.sp.nanomsg.org']);\n        ws.binaryType = \"arraybuffer\";\n\n        ws.onmessage = async (ev) => {\n            try {\n                let data = ev.data;\n                if (data instanceof Blob) data = await data.arrayBuffer();\n\n                const u8 = stripTrailingNulls(new Uint8Array(data));\n                const text = new TextDecoder(\"utf-8\").decode(u8);\n                const msg = JSON.parse(text);\n\n                switch (msg.type) {\n                    case \"HW::resource\": {\n\n                        const targets = msg.targets.map((v) => {\n                            return basename(v);\n                        });\n                        const exts = targets.map((v) => {\n                            return v.split('.').pop();\n                        });\n\n                        const unique_exts = [...new Set(exts)];\n\n                        if (unique_exts.includes(\"css\")) {\n                            reloadCSS();\n                        }\n\n                        if (!unique_exts.every(ext => ext === \"css\")) {\n                            reloadImages();\n                        }\n\n                        break;\n                    }\n                    case \"HW::page\": {\n                        window.location.reload();\n                        break;\n                    }\n                    default: throw new Error(`Unknown payload ${msg.type}`)\n                }\n            } catch (error) {\n                console.log(error);\n            }\n        };\n    })();\n</script>"

